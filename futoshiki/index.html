<!DOCTYPE html>
<!--
               Copyright (C) 2019 Guillaume Moroz

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 2 of the License, or
(at your option) any later version.
                 http://www.gnu.org/licenses/
-->
<html>
    <head>
        <title> Futoshiki </title>
        <!--<link rel="stylesheet" type="text/css" href="futoshiki.css">-->
        <style>
            :root {
                --n: 7;
                --ratio_square: 80;
                --ratio_gap:    20;
                --unit: calc(100vmin/(var(--n)*var(--ratio_square) + (var(--n) + 1)*var(--ratio_gap)));
                --gap: calc(var(--unit)*var(--ratio_gap));
                --square: calc(var(--unit)*var(--ratio_square));
                --cell: calc(var(--gap) + var(--square));
                --edge: calc(var(--cell)*var(--n) - var(--gap));
                --side: calc(var(--edge) / 7);
                --left: calc((100vw - var(--edge))/2);
                --sideleft: calc((100vmin - 3*var(--side) - 3px)/2);
                --sidetop: calc((100vmin - 3*var(--side) - 3px + 2*var(--gap) + var(--side))/2);
            }

            body {
                margin: 0;
                padding: 0;
                text-align: center;
            }

            @media (orientation:portrait) {
                .theme_bar .grid {
                    bottom: calc(3*var(--cell));
                    left: var(--left);
                }

                .theme_bar .side {
                    flex-direction: row;
                    bottom: var(--gap);
                }

                .theme_pad .grid {
                    bottom: calc(5*var(--side));
                    left: calc(var(--left) + 1px);
                }

                .theme_pad .side {
                    bottom: var(--gap);
                    left: var(--sideleft);
                }

                .theme_pad .button_highlight {
                    bottom: calc(3*var(--side) + 2*var(--gap));
                    left: calc(var(--sideleft) + var(--side) + 1px);
                }
            }

            @media (orientation:landscape) {
                .theme_bar .side {
                    flex-direction: column;
                    right: var(--gap);
                }

                .theme_pad .side {
                    right: var(--gap);
                    top: var(--sidetop);
                }

                .theme_pad .grid {
                    top: var(--gap);
                    left: calc(1*var(--cell));
                }

                .theme_pad .button_highlight {
                    right: calc(var(--gap) + var(--side) + 1px);
                    top: calc(var(--sidetop) - 2*var(--gap) - var(--side));
                }
            }

            /*Menu buttons*/
            .button_highlight {
                position: absolute;
                width: var(--side);
                height: var(--side);
                border: 1px solid;
                background-color: lightgray;
            }

            body .focus {
                border: 4px solid;
                margin: -4px;
            }

            /*side choice list*/
            .theme_bar .side {
                display: flex;
                position: absolute;
                margin: 0;
                padding: 0;
            }

            .theme_pad .side {
                position: absolute;
                display: flex;
                flex-wrap: wrap;
                width: calc(3*var(--side) + 3px);
                height: calc(3*var(--side) + 3px);
                justify-content: left;
                align-items: center;
                text-align: center;
            }

            .side .square {
                display: flex;
                border: 1px solid;
                width: var(--side);
                height: var(--side);
                font-size: calc(var(--side));
                justify-content: center;
                align-items: center;
                text-align: center;
                margin: 0 -1px -1px 0;
            }

            /*side variable style*/
            .side .strikeout {
                font-size: 0;
            }

            .side .highlight {
                background-color: lightgray;
            }

            /*main grid*/
            .grid {
                display: grid;
                position: absolute;
                grid-template-columns: repeat(var(--n), var(--cell));
                grid-auto-rows: var(--cell);
            }

            .grid .cell {
                display: grid;
                grid-template-columns: var(--square) var(--gap);
            }

            /*inequalities between squares*/
            .cell .right {
                display: flex;
                font-size: var(--square);
                width: var(--gap);
                height: var(--square);
                justify-content: center;
                align-items: center;
                transform: scale(0.2, 1);
            }

            .cell .below {
                display: flex;
                width: var(--square);
                height: var(--gap);
                font-size: var(--square);
                justify-content: center;
                align-items: center;
                transform: rotate(90deg) scale(0.2, 1);
            }

            /*squares*/
            .cell .square {
                display: flex;
                flex-wrap: wrap;
                border: 1px solid;
                width: var(--square);
                height: var(--square);
                justify-content: left;
                align-items: top;
                text-align: center;
                margin: -1px;
            }

            /*squares variable style*/
            .cell .focus {
                border: 4px solid;
                margin: -4px;
            }

            .cell .highlight {
                background-color: lightgray;
            }

            /*number default style*/
            .square .guess {
                color: grey;
            }

            .square .multiple {
                font-size: calc(var(--square)/3);
                width: calc(var(--square)/3.1);
                height: calc(var(--square)/3);
            }

            /*number variable style*/
            .square .board {
                color: black;
            }

            .square .unique {
                position: absolute;
                display: flex;
                font-size: calc(var(--square)*1.1);
                width: var(--square);
                height: var(--square);
                justify-content: center;
                align-items: center;
            }

            .square .alert {
                color: red;
            }

            /*general style effects*/
            .hide {
                visibility: hidden;
            }

            .remove {
                display: none;
            }
        </style>

        <script type="text/javascript">
            // Global variables
            var n = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--n'));
            var board_square = Array.from(Array(n), () => new Array(n));
            var board_horizontal = Array.from(Array(n), () => new Array(n));
            var board_vertical = Array.from(Array(n), () => new Array(n));
            var board_side = new Array(n);
            var board_highlight = null;
            var ineq = new Object();
            ineq["<"] = document.createTextNode("<");
            ineq[">"] = document.createTextNode(">");

            var selected_element = null;

            // Menu drawing : Edit, Guess, Highlight, Undo, Choose
            function createMenu() {
                var highlight = document.createElement("div");
                highlight.classList.add("button_highlight");
                highlight.setAttribute('onmousedown', 'modeHighlight()');
                highlight.setAttribute('ontouchstart', 'modeHighlight(); event.preventDefault()');
                document.body.appendChild(highlight);
                board_highlight = highlight;

                //var guess = document.createElement("div");
                //guess.classList.add("button_guess");
                //guess.setAttribute('onmousedown', 'modeGuess()');
                //guess.setAttribute('ontouchstart', 'modeGuess(); event.preventDefault()');
            }

            // Side bar drawing
            function createSide() {
                var side = document.createElement("div");
                side.classList.add("side");
                document.body.appendChild(side);
                for(i = 0; i < n; i++) {
                    square = document.createElement("div")
                    square.classList.add("square");
                    square.setAttribute('num', i)
                    num_content = document.createTextNode(i+1);
                    square.appendChild(num_content);
                    side.appendChild(square);
                    board_side[i] = square;
                }
            }

            // Grid drawing and styling
            function createGrid() {
                var grid = document.createElement("div");
                grid.classList.add("grid");
                document.body.appendChild(grid);
                for(i = 0; i < n; i++) {
                    for(j = 0; j < n; j++) {
                        cell = document.createElement("div")
                        cell.classList.add("cell");
                        cell.classList.add("id" + i + j);
                        grid.appendChild(cell);

                        square = document.createElement("div")
                        square.classList.add("square");
                        square.setAttribute('row', i);
                        square.setAttribute('col', j);
                        square.setAttribute('onmousedown', 'modeGuess(); select(this)');
                        square.setAttribute('ontouchstart', 'modeGuess(); select(this); event.preventDefault()');
                        cell.appendChild(square);
                        board_square[i][j] = square;

                        for(k = 0; k < n; k++) {
                            var num = document.createElement("div");
                            num.classList.add("multiple");
                            num.classList.add("guess");
                            num.classList.add("hide");
                            num_content = document.createTextNode(k+1);
                            num.appendChild(num_content);
                            square.appendChild(num);
                        }

                        right = document.createElement("div")
                        right.classList.add("right");
                        cell.appendChild(right);
                        board_horizontal[i][j] = right;

                        below = document.createElement("div")
                        below.classList.add("below");
                        cell.appendChild(below);
                        board_vertical[i][j] = below;
                    }
                }
            }

            function modeGuess() {
                if(board_highlight != null) {
                    board_highlight.classList.remove("focus");
                }
                for(i = 0; i < n; i++) {
                    board_side[i].setAttribute('onmousedown', 'toggleGuess(this)');
                    board_side[i].setAttribute('ontouchstart', 'toggleGuess(this); event.preventDefault()');
                }
            }

            function modeHighlight() {
                if(selected_element != null) {
                    selected_element.classList.remove("focus");
                    selected_element = null;
                }
                if(board_highlight != null) {
                    board_highlight.classList.add("focus");
                }
                for(i = 0; i < n; i++) {
                    board_side[i].setAttribute('onmousedown', 'toggleHighlight(this)');
                    board_side[i].setAttribute('ontouchstart', 'toggleHighlight(this); event.preventDefault()');
                    board_side[i].classList.remove("strikeout");
                }
            }

            function toggleHighlight(element) {
                if(!element.classList.contains("highlight")) {
                    element.classList.add("highlight");
                    var num = element.getAttribute("num");
                    for(i = 0; i < n; i++) {
                        for(j = 0; j < n; j++) {
                            if(!board_square[i][j].childNodes[num].classList.contains("hide")) {
                                board_square[i][j].classList.add("highlight");
                            }
                        }
                    }
                } else {
                    element.classList.remove("highlight");
                    var numlist = [];
                    for(i = 0; i < n; i++) {
                        if(board_side[i].classList.contains("highlight")) {
                            numlist.push(i);
                        }
                    }
                    for(i = 0; i < n; i++) {
                        for(j = 0; j < n; j++) {
                            board_square[i][j].classList.remove("highlight");
                            for(k = 0; k < numlist.length; k++) {
                                if(!board_square[i][j].childNodes[numlist[k]].classList.contains("hide")) {
                                    board_square[i][j].classList.add("highlight");
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            // set fixed numbers from a board
            // assumes no number are visible at first
            function setBoardNumber(i, j, k) {
                board_square[i-1][j-1].removeAttribute('onmousedown');
                board_square[i-1][j-1].removeAttribute('ontouchstart');
                var num_list = board_square[i-1][j-1].childNodes;
                num_list[k-1].classList.remove("hide");
                num_list[k-1].classList.add("unique");
                num_list[k-1].classList.add("board");
            }

            // fill board with a game given by 3 arrays
            function loadBoard(numbers, horizontal, vertical) {
                for(i = 0; i < numbers.length; i++) {
                    setBoardNumber(numbers[i][0], numbers[i][1], numbers[i][2]);
                }
                for(i = 0; i < horizontal.length; i++) {
                    board_horizontal[horizontal[i][0]-1][horizontal[i][1]-1].appendChild(ineq[horizontal[i][2]].cloneNode());
                }
                for(i = 0; i < vertical.length; i++) {
                    board_vertical[vertical[i][0]-1][vertical[i][1]-1].appendChild(ineq[vertical[i][2]].cloneNode());
                }
            }

            function select(element) {
                if(selected_element != null) {
                    selected_element.classList.remove("focus");
                }
                element.classList.add("focus");
                selected_element = element;
                for(i = 0; i < n; i++) {
                    num = element.childNodes[i];
                    if(num.classList.contains("hide")) {
                        board_side[i].classList.add("strikeout");
                    } else {
                        board_side[i].classList.remove("strikeout");
                    }
                }
            }

            //TODO : update hilight when guess changes in a square
            function toggleGuess(element) {
                if(selected_element == null) {
                    return;
                }
                var num = element.getAttribute("num");
                var row = parseInt(selected_element.getAttribute("row"));
                var col = parseInt(selected_element.getAttribute("col"));
                element.classList.toggle("strikeout");
                selected_element.childNodes[num].classList.toggle("hide");
                var count = 0;
                var unique = 0;
                for(i = 0; i < n; i++) {
                    selected_element.childNodes[i].classList.remove("unique");
                    selected_element.childNodes[i].classList.remove("alert");
                    if(selected_element.childNodes[i].classList.contains("hide")) {
                        count += 1;
                    } else {
                        unique = i;
                    }
                }
                if(count == n-1) {
                    selected_element.childNodes[unique].classList.add("unique");
                    if(!checkLatinRow(row, col, unique)
                       || !checkLatinCol(row, col, unique)
                       || !checkIneq(row, col, unique)) {
                        selected_element.childNodes[unique].classList.add("alert");
                    }
                }
                // update highlight
                selected_element.classList.remove("highlight");
                for(k = 0; k < n; k++) {
                    if(board_side[k].classList.contains("highlight")
                       &&
                       !selected_element.childNodes[k].classList.contains("hide")) {
                        selected_element.classList.add("highlight");
                        break;
                    }
                }

            }

            function checkLatinRow(row, col, unique) {
                for(i = 0; i < n; i++) {
                    if(i != col) {
                        for(j = 0; j < n; j++) {
                            if(board_square[row][i].childNodes[j].classList.contains("unique")) {
                                if(j == unique) {
                                    return false;
                                }
                            }
                        }
                    }
                }
                return true;
            }

            function checkLatinCol(row, col, unique) {
                for(i = 0; i < n; i++) {
                    if(i != row) {
                        for(j = 0; j < n; j++) {
                            if(board_square[i][col].childNodes[j].classList.contains("unique")) {
                                if(j == unique) {
                                    return false;
                                }
                            }
                        }
                    }
                }
                return true;
            }

            function getUnique(element) {
                for(j = 0; j < n; j++) {
                    if(element.childNodes[j].classList.contains("unique")) {
                        return j;
                    }
                }
                return -1;
            }

            function checkIneq(row, col, unique) {
                if(col > 0) {
                    var candidate = getUnique(board_square[row][col-1]);
                    if((candidate > -1) &&
                       ( (candidate >= unique &&
                          board_horizontal[row][col-1].textContent == "<")
                         ||
                         (candidate <= unique &&
                          board_horizontal[row][col-1].textContent == ">")))
                    {
                        return false;
                    }
                }
                if(col < n-1) {
                    var candidate = getUnique(board_square[row][col+1]);
                    if((candidate > -1) &&
                       ( (candidate >= unique &&
                          board_horizontal[row][col].textContent == ">")
                         ||
                         (candidate <= unique &&
                          board_horizontal[row][col].textContent == "<")))
                    {
                        return false;
                    }
                }
                if(row > 0) {
                    var candidate = getUnique(board_square[row-1][col]);
                    if((candidate > -1) &&
                       ( (candidate >= unique &&
                          board_vertical[row-1][col].textContent == "<")
                         ||
                         (candidate <= unique &&
                          board_vertical[row-1][col].textContent == ">")))
                    {
                        return false;
                    }
                }
                if(row < n-1) {
                    var candidate = getUnique(board_square[row+1][col]);
                    if((candidate > -1) &&
                       ( (candidate >= unique &&
                          board_vertical[row][col].textContent == ">")
                         ||
                         (candidate <= unique &&
                          board_vertical[row][col].textContent == "<")))
                    {
                        return false;
                    }
                }
                return true
            }

            function loadGame() {
                var numbers = [ [1, 3, 6], [1, 5, 2], [2, 4, 3], [3, 1, 4], [3, 7, 7], [4, 2, 1], [4, 6, 3], [5, 1, 3], [5, 7, 5], [6, 4, 2], [7, 3, 3], [7, 5, 4]];
                var horizontal = [ [2, 2, "<"], [2, 5, "<"], [4, 4, ">"], [6, 1, ">"], [6, 4, "<"], [6, 6, ">"] ];
                var vertical = [ [4, 1, ">"], [1, 3, ">"], [4, 3, ">"], [5, 6, ">"]];
                document.body.classList.add("theme_pad");
                createMenu();
                createSide();
                createGrid();
                modeGuess();
                loadBoard(numbers, horizontal, vertical);
            }
        </script>
    </head>

    <body onload="loadGame()">
    </body>
</html>
